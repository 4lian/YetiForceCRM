
jQuery.Class("Vtiger_TreeCategory_Js",{},{modalContainer:false,treeInstance:false,treeData:false,getModalContainer:function(){if(this.modalContainer==false){this.modalContainer=jQuery("#globalmodal .modal-content")}return this.modalContainer},getRecords:function(b){if(this.treeData==false&&b!="undefined"){var a=b.find("#treePopupValues").val();this.treeData=JSON.parse(a)}return this.treeData},generateTree:function(a){var b=this;if(b.treeInstance==false){b.treeInstance=a.find("#treePopupContents");b.treeInstance.jstree({core:{data:b.getRecords(),themes:{name:"proton",responsive:true}},plugins:["category","checkbox","search"]})}},searching:function(a){this.treeInstance.jstree(true).search(a)},registerSearchEvent:function(){var c=this;var a=$("#valueSearchTree");var b=$("#btnSearchTree");a.keypress(function(d){if(d.which==13){c.searching(a.val())}});b.click(function(){c.searching(a.val())})},registerSaveRecords:function(b){var i=this,c=[],e=[],f=[],a=[],g=[],d=[],h=[];$.each(i.getRecords(),function(j,k){if(k.state.selected&&k.type=="record"){c.push(k.record_id)}if(k.category&&k.category.selected){e.push(k.record_id)}});b.find('[name="saveButton"]').on("click",function(j){$(this).attr("disabled","disabled");$.each(i.treeInstance.jstree("get_selected",true),function(k,l){if(jQuery.inArray(l.original.record_id,c)==-1&&l.original.type=="record"){a.push(l.original.record_id)}f.push(l.original.record_id)});d=i.treeInstance.jstree("getCategory");$.each(c,function(k,l){if(jQuery.inArray(l,f)==-1){g.push(l)}});$.each(e,function(k,l){if(jQuery.inArray(l,f)==-1){h.push(l)}});AppConnector.request({module:app.getModuleName(),action:"RelationAjax",mode:"updateRelation",recordsToAdd:a,recordsToRemove:g,categoryToAdd:a,categoryToRemove:g,src_record:app.getRecordId(),related_module:b.find('[name="related_module"]').val(),}).then(function(l){var m=Vtiger_Detail_Js.getInstance();var k=m.getSelectedTab();m.registerRelatedModulesRecordCount(k);k.trigger("click");app.hideModalWindow()})})},registerCounterSelected:function(){var a=this;this.treeInstance.on("changed.jstree",function(f,c){var d=0;var b="";$.each(a.treeInstance.jstree("get_selected",true),function(e,g){var h=g.original.record_id.toString();if(h.indexOf("T")){d++}});b=app.vtranslate("JS_SELECTED_ELEMENTS")+": "+d;$(".counterSelected").text(b)})},registerEvents:function(){var a=this.getModalContainer();this.getRecords(a);this.generateTree(a);this.registerSaveRecords(a);this.registerSearchEvent();this.registerCounterSelected()}});jQuery(function(){var a=new Vtiger_TreeCategory_Js();a.registerEvents()});