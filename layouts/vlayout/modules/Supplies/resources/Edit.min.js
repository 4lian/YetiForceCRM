
Vtiger_Edit_Js("Supplies_Edit_Js",{},{lineItemContentsContainer:false,rowClass:"tr.rowSup",discountMondalFields:["aggregationType","globalDiscount","groupCheckbox","groupDiscount","individualDiscount","individualDiscountType"],taxMondalFields:["aggregationType","globalTax","groupCheckbox","groupTax","individualTax"],getSupTableContainer:function(){if(this.lineItemContentsContainer==false){this.lineItemContentsContainer=$(".suppliesItemTable")}return this.lineItemContentsContainer},getNextLineItemRowNumber:function(){var a=$(this.rowClass,this.getSupTableContainer()).length;$("#suppliesRowNo").val(a+1);return ++a},getAccountId:function(){var a=$("#accountReferenceField").val();if(a!=""){return $('[name="'+a+'"]').val()}return""},checkDeleteIcon:function(){var a=this.getSupTableContainer();if(a.find(this.rowClass).length>1){this.showLineItemsDeleteIcon()}else{this.hideLineItemsDeleteIcon()}},showLineItemsDeleteIcon:function(){this.getSupTableContainer().find(".deleteRow").removeClass("hide")},hideLineItemsDeleteIcon:function(){this.getSupTableContainer().find(".deleteRow").addClass("hide")},getClosestRow:function(a){return a.closest(this.rowClass)},getBasicRow:function(){var a=$("#blackSuppliesTable tbody").clone(true,true);return a},isRecordSelected:function(b){var c=b.closest("tr");var d=c.find(".recordLabel");var a=d.validationEngine("validate");return a},getTaxModeSelectElement:function(b){var a=this.getSupTableContainer();if(a.find("thead .taxMode").length>0){return $(".taxMode")}return b.find(".taxMode")},isIndividualTaxMode:function(c){var a=this.getTaxModeSelectElement(c);var b=a.find("option:selected");if(b.val()=="1"){return true}return false},isGroupTaxMode:function(){var a=this.getTaxModeSelectElement();var b=a.find("option:selected");if(b.val()=="0"){return true}return false},showIndividualTax:function(c){var b=this;var a=b.getSupTableContainer().find(".colTax");if(b.isIndividualTaxMode()){a.removeClass("hide")}else{a.addClass("hide");a.find(".tax").val("0");b.rowsCalculations()}},getDiscountModeSelectElement:function(b){var a=this.getSupTableContainer();if(a.find("thead .discountMode").length>0){return $(".discountMode")}return b.find(".discountMode")},isIndividualDiscountMode:function(c){var a=this.getDiscountModeSelectElement(c);var b=a.find("option:selected");if(b.val()=="1"){return true}return false},showIndividualDiscount:function(c){var b=this;var a=b.getSupTableContainer().find(".colDiscount");if(b.isIndividualDiscountMode()){a.removeClass("hide")}else{a.addClass("hide");a.find(".discount").val("0");b.rowsCalculations()}},getCurrency:function(){var a=$('[name="currency"]',this.getSupTableContainer());return a.find("option:selected").val()},getTax:function(a){return app.parseNumberToFloat($(".tax",a).val())},getQuantityValue:function(a){return app.parseNumberToFloat($(".qty",a).val())},getUnitPriceValue:function(a){return app.parseNumberToFloat($(".unitPrice",a).val())},getDiscount:function(a){var b=$(".discount",a).val();if(b==undefined){b=0}return app.parseNumberToFloat(b)},getNetPrice:function(a){return app.parseNumberToFloat($(".netPrice",a).val())},getTotalPrice:function(a){return app.parseNumberToFloat($(".totalPrice",a).val())},getGrossPrice:function(a){return app.parseNumberToFloat($(".grossPrice",a).val())},getPurchase:function(a){var b=this.getQuantityValue(a);return app.parseNumberToFloat($(".purchase",a).val())*b},getSummaryGrossPrice:function(){var b=this;var a=0;this.getSupTableContainer().find(this.rowClass).each(function(c){a+=b.getGrossPrice($(this))});return app.parseNumberToFloat(a)},setUnitPriceValue:function(b,a){b.find(".unitPrice").val(a).attr("title",a);return this},setNetPrice:function(b,a){a=app.parseNumberToShow(a);$(".netPriceText",b).text(a);$(".netPrice",b).val(a)},setGrossPrice:function(b,a){a=app.parseNumberToShow(a);$(".grossPriceText",b).text(a);$(".grossPrice",b).val(a)},setTotalPrice:function(b,a){a=app.parseNumberToShow(a);$(".totalPriceText",b).text(a);$(".totalPrice",b).val(a)},setMargin:function(b,a){a=app.parseNumberToShow(a);$(".margin",b).val(a)},setMarginP:function(b,a){a=app.parseNumberToShow(a);$(".marginp",b).val(a)},quantityChangeActions:function(a){this.rowCalculations(a);this.summaryCalculations()},rowCalculations:function(a){this.calculateTotalPrice(a);this.calculateNetPrice(a);this.calculateGrossPrice(a);this.calculateMargin(a)},rowsCalculations:function(){var a=this;this.getSupTableContainer().find(this.rowClass).each(function(b){a.quantityChangeActions($(this))})},summaryCalculations:function(){var a=this;this.getSupTableContainer().find("tfoot .wisableTd").each(function(b){a.calculatSummary($(this),$(this).data("sumfield"))})},calculatSummary:function(a,d){var c=this;var b=0;this.getSupTableContainer().find(this.rowClass).each(function(e){b+=app.parseNumberToFloat($(this).find("."+d).val())});a.text(app.parseNumberToShow(b))},calculateNetPrice:function(a){var b=this.getTotalPrice(a)-this.getDiscount(a);this.setNetPrice(a,b)},calculateGrossPrice:function(b){var c=this.getNetPrice(b);if(this.isIndividualTaxMode(b)){var a=this.getTax(b);c+=a}this.setGrossPrice(b,c)},calculateTotalPrice:function(b){var a=this.getQuantityValue(b)*this.getUnitPriceValue(b);this.setTotalPrice(b,a)},calculateMargin:function(d){var e=this.getNetPrice(d);var b=this.getPurchase(d);var c=e-b;this.setMargin(d,c);var a="0";if(b!==0){a=(c/b)*100}this.setMarginP(d,a)},calculateDiscount:function(j,c){var e=this.getTotalPrice(j),b=e,k=0,f=0,g=0,a=0;var i=c.find(".discountsType").val();if(i=="0"||i=="1"){if(c.find(".activepanel .globalDiscount").length>0){var k=c.find(".activepanel .globalDiscount").val()}if(c.find(".activepanel .individualDiscountType").length>0){var d=c.find('.activepanel .individualDiscountType[name="individual"]:checked').val();var h=c.find(".activepanel .individualDiscountValue").val();if(d=="percentage"){g=(h/100)*e}else{g=h}}if(c.find(".activepanel .groupCheckbox").length>0&&c.find(".activepanel .groupCheckbox").prop("checked")==true){var f=c.find(".groupValue").val();f=e*(parseFloat(f)/100)}b=b*((100-parseFloat(k))/100);b=b-parseFloat(g);b=b-parseFloat(f)}else{if(i=="2"){c.find(".activepanel").each(function(n){var m=$(this);if(m.find(".globalDiscount").length>0){var o=parseFloat(m.find(".globalDiscount").val());b=b*((100-o)/100)}else{if(m.find(".groupCheckbox").length>0&&m.find(".groupCheckbox").prop("checked")==true){var l=parseFloat(m.find(".groupValue").val());b=b*((100-l)/100)}else{if(m.find(".individualDiscountType").length>0){var p=parseFloat(m.find(".individualDiscountValue").val());if(m.find('.individualDiscountType[name="individual"]:checked').val()=="percentage"){b=b*((100-p)/100)}else{b=b-p}}}}})}}c.find(".valuePrices").text(app.parseNumberToFloat(b));c.find(".valueDiscount").text(e-app.parseNumberToFloat(b))},calculateTax:function(k,g){var h=this.getTotalPrice(k),b=h,c=0,f=0,a=0,i=0,e=0;var d=g.find(".taxsType").val();if(d=="0"||d=="1"){if(g.find(".activepanel .globalTax").length>0){var c=g.find(".activepanel .globalTax").val()}if(g.find(".activepanel .individualTaxValue").length>0){var j=g.find(".activepanel .individualTaxValue").val();i=(j/100)*b}if(g.find(".activepanel .groupTax").length>0){var f=g.find(".groupTax").val();f=h*(parseFloat(f)/100)}if(g.find(".activepanel .regionalTax").length>0){var a=g.find(".regionalTax").val();a=h*(parseFloat(a)/100)}b=b*((100+parseFloat(c))/100);b=b+parseFloat(i);b=b+parseFloat(f);b=b+parseFloat(a)}else{if(d=="2"){g.find(".activepanel").each(function(p){var l=$(this);if(l.find(".globalTax").length>0){var o=parseFloat(l.find(".globalTax").val());b=b*((100+o)/100)}else{if(l.find(".groupTax").length>0){var n=parseFloat(l.find(".groupTax").val());b=b*((100+n)/100)}else{if(l.find(".regionalTax").length>0){var m=parseFloat(l.find(".regionalTax").val());b=b*((100+m)/100)}else{if(l.find(".individualTaxValue").length>0){var q=parseFloat(l.find(".individualTaxValue").val());b=((q+100)/100)*b}}}}})}}g.find(".valuePrices").text(app.parseNumberToFloat(b));g.find(".valueTax").text(app.parseNumberToFloat(b-h))},updateRowSequence:function(){var a=this.getSupTableContainer();a.find(this.rowClass).each(function(b){$(this).find(".sequence").val(b+1)})},registerSuppliesSaveData:function(a){var b=this;a.on(Vtiger_Edit_Js.recordPreSave,function(f,d){if(!b.checkLimits(a)){return false}var c=a.find("#blackSuppliesTable");c.find("[name]").removeAttr("name")})},pricebooksPopupHandler:function(a){var d=this;var c=a.closest(this.rowClass);var b=c.find(".rowName");var e={};e.module="PriceBooks";e.src_module=$('[name="popupReferenceModule"]',b).val();e.src_record=$(".sourceField",b).val();e.src_field=$('[name="popupReferenceModule"]',b).data("field");e.get_url="getProductUnitPriceURL";e.currency_id=d.getCurrency();this.showPopup(e).then(function(g){var f=JSON.parse(g);for(var h in f){d.setUnitPriceValue(c,f[h])}d.quantityChangeActions(d.getClosestRow(b))})},showPopup:function(c){var a=$.Deferred();var b=Vtiger_Popup_Js.getInstance();b.show(c,function(d){a.resolve(d)});return a.promise()},subProductsCashe:[],loadSubProducts:function(g,a){var d=this;var c=jQuery("input.sourceField",g).val();var e=g.find('.rowName input[name="popupReferenceModule"]').val();d.removeSubProducts(g);if(c=="0"||$.inArray(e,["Products","Services"])<0){return false}if(d.subProductsCashe[c]){d.addSubProducts(g,d.subProductsCashe[c]);return false}var f={module:"Products",action:"SubProducts",record:c};if(a){var b=jQuery.progressIndicator()}AppConnector.request(f).then(function(i){var h=i.result;d.subProductsCashe[c]=h;d.addSubProducts(g,h);if(b){b.hide()}},function(h,i){if(b){b.hide()}})},removeSubProducts:function(a){var b=$(".subProductsContainer ul",a);b.find("li").remove()},addSubProducts:function(c,b){var e=$(".subProductsContainer ul",c);for(var d in b){var a=$("<li>").text(b[d]);e.append(a)}},mapResultsToFields:function(f,k,c){var i=this;for(var b in c){var a=c[b];var j=a.description;var e=a.unitPriceValues;var d=JSON.stringify(e);for(var g in a){k.find("input."+g).val(a[g])}var h=i.getCurrency();if(typeof e[h]!=="undefined"){i.setUnitPriceValue(k,e[h])}$("input.unitPrice",k).attr("list-info",d);$("textarea.commentTextarea",k).val(j);i.showIndividualTax(k)}if(f==="Products"){i.loadSubProducts(k,true)}this.quantityChangeActions(k)},saveDiscountsParameters:function(d,a){var b=this;var c={};var e=["aggregationType","groupCheckbox","individualDiscountType"];$.each(b.discountMondalFields,function(f,g){if($.inArray(g,e)>=0){if(a.find('[name="'+g+'"]:checked').length>1){c[g]=[];a.find('[name="'+g+'"]:checked').each(function(h){c[g].push($(this).val())})}else{c[g]=a.find('[name="'+g+'"]:checked').val()}}else{c[g]=a.find('[name="'+g+'"]').val()}});d.find(".discountParam").val(JSON.stringify(c))},saveTaxsParameters:function(d,a){var b=this;var c={};var e=["aggregationType","groupCheckbox","individualTaxType"];$.each(b.taxMondalFields,function(f,g){if($.inArray(g,e)>=0){if(a.find('[name="'+g+'"]:checked').length>1){c[g]=[];a.find('[name="'+g+'"]:checked').each(function(h){c[g].push($(this).val())})}else{c[g]=a.find('[name="'+g+'"]:checked').val()}}else{c[g]=a.find('[name="'+g+'"]').val()}});d.find(".taxParam").val(JSON.stringify(c))},showExpandedRow:function(e){var d=this;var c=d.getSupTableContainer();var b=c.find('[numrowex="'+e.attr("numrow")+'"]');var a=e.find(".toggleVisibility");a.data("status","1");a.find(".glyphicon").removeClass("glyphicon-menu-down");a.find(".glyphicon").addClass("glyphicon-menu-up");b.removeClass("hide");d.loadCkEditorElement(b.find(".ckEditorSource"))},hideExpandedRow:function(f){var e=this;var d=e.getSupTableContainer();var c=d.find('[numrowex="'+f.attr("numrow")+'"]');var b=f.find(".toggleVisibility");b.data("status","0");b.find(".glyphicon").removeClass("glyphicon-menu-up");b.find(".glyphicon").addClass("glyphicon-menu-down");c.addClass("hide");var a=CKEDITOR.instances[c.find(".ckEditorSource").attr("id")];if(a){a.destroy()}},initDiscountsParameters:function(d,a){var c=this;var b=d.find(".discountParam").val();if(b==""){return}var b=JSON.parse(b);$.each(c.discountMondalFields,function(e,g){var i=b[g];var f=a.find('[name="'+g+'"]');if(f.attr("type")=="checkbox"||f.attr("type")=="radio"){var h=i;if(!$.isArray(h)){h=[h]}$.each(h,function(j,k){var l=f.filter('[value="'+k+'"]').prop("checked",true);if(g=="aggregationType"){l.closest(".panel").find(".panel-body").show();l.closest(".panel").addClass("activepanel")}})}else{if(f.prop("tagName")=="SELECT"){f.find('option[value="'+i+'"]').prop("selected","selected").change()}else{a.find('[name="'+g+'"]').val(i)}}});c.calculateDiscount(d,a)},initTaxParameters:function(d,a){var c=this;var b=d.find(".taxParam").val();if(b==""){return}var b=JSON.parse(b);$.each(c.taxMondalFields,function(e,g){var i=b[g];var f=a.find('[name="'+g+'"]');if(f.attr("type")=="checkbox"||f.attr("type")=="radio"){var h=i;if(!$.isArray(h)){h=[h]}$.each(h,function(j,k){var l=f.filter('[value="'+k+'"]').prop("checked",true);if(g=="aggregationType"){l.closest(".panel").find(".panel-body").show();l.closest(".panel").addClass("activepanel")}})}else{if(f.prop("tagName")=="SELECT"){f.find('option[value="'+i+'"]').prop("selected","selected").change()}else{a.find('[name="'+g+'"]').val(i)}}});c.calculateTax(d,a)},limitEnableSave:false,checkLimits:function(){var c=this;var d=c.getAccountId();var a=true;if(d==""||$("#suppliesLimit").val()=="0"||c.limitEnableSave){return true}var e={};e.data={module:app.getModuleName(),action:"CheckLimits",record:d,currency:c.getCurrency(),price:c.getSummaryGrossPrice(),limitConfig:$("#suppliesLimit").val(),};e.async=false;e.dataType="json";var b=jQuery.progressIndicator();AppConnector.request(e).then(function(f){b.hide();var g=c.getForm();if(f.result.status==false){app.showModalWindow(f.result.html,function(h){h.find(".enableSave").on("click",function(j,i){c.limitEnableSave=true;g.submit();app.hideModalWindow()})});a=false}},function(f,g){b.hide()});return a},registerAddRow:function(a){var c=this;var b=this.getSupTableContainer();a.find(".btn-toolbar .addButton").on("click",function(h,f){var l=a.find("#blackSuppliesTable");var m=c.getBasicRow();var i=c.getNextLineItemRowNumber();var d=$(h.currentTarget).data("module");var j=$(h.currentTarget).data("field");var g=$(h.currentTarget).data("wysiwyg");var k=m.html().replace(/_NUM_/g,i);m.html(k);m=m.find("tr").appendTo(b.find("tbody"));m.find('.rowName input[name="popupReferenceModule"]').val(d).data("field",j);c.registerAutoCompleteFields(m);c.initRow(m)})},registerSortableRow:function(){var b=this;var a=b.getSupTableContainer();a.sortable({handle:".dragHandle",items:b.rowClass,revert:true,tolerance:"pointer",placeholder:"ui-state-highlight",helper:function(d,c){c.children().each(function(e,f){f=$(f);f.width(f.width())});return c},start:function(c,d){a.find(b.rowClass).each(function(e,f){var g=$(f);b.hideExpandedRow(g)});d.item.startPos=d.item.index()},stop:function(d,e){var c=$(e.item.context).attr("numrow");var f=a.find(".numRow"+c).remove().clone();a.find('[numrow="'+c+'"]').after(f);if(e.item.startPos<e.item.index()){var f=a.find(".numRow"+c).next().remove().clone();a.find('[numrow="'+c+'"]').before(f)}b.updateRowSequence()}});a.disableSelection()},registerShowHideExpanded:function(a){var b=this;a.on("click",".toggleVisibility",function(d){var c=$(d.currentTarget);var f=b.getClosestRow(c);if(c.data("status")=="0"){b.showExpandedRow(f)}else{b.hideExpandedRow(f)}})},registerPriceBookPopUp:function(a){var b=this;a.on("click",".priceBookPopup",function(f){var d=$(f.currentTarget);var c=b.isRecordSelected(d);if(c==true){return}b.pricebooksPopupHandler(d)})},registerRowChangeEvent:function(a){var b=this;a.on("focusout",".qty",function(d){var c=$(d.currentTarget);b.quantityChangeActions(b.getClosestRow(c))});a.on("focusout",".unitPrice",function(d){var c=$(d.currentTarget);b.quantityChangeActions(b.getClosestRow(c))});a.on("focusout",".purchase",function(d){var c=$(d.currentTarget);b.quantityChangeActions(b.getClosestRow(c))});a.on("change",".taxMode",function(d){var c=$(d.currentTarget);b.showIndividualTax(b.getClosestRow(c))});a.on("change",".discountMode",function(d){var c=$(d.currentTarget);b.showIndividualDiscount(b.getClosestRow(c))})},registerSubProducts:function(a){var b=this;a.find(this.rowClass).each(function(c){b.loadSubProducts($(this),false)})},registerClearReferenceSelection:function(a){var b=this;a.on("click",".clearReferenceSelection",function(d){var c=$(d.currentTarget);var f=b.getClosestRow(c);b.removeSubProducts(f);f.find(".unitPrice,.tax,.discount,.margin,.purchase").val("0");f.find("textarea").val("");b.quantityChangeActions(f)})},registerDeleteLineItemEvent:function(a){var b=this;a.on("click",".deleteRow",function(d){var c=$(d.currentTarget);b.getClosestRow(c).remove();b.checkDeleteIcon()})},registerChangeDiscount:function(a){var b=this;a.on("click",".changeDiscount",function(g){var d=$(g.currentTarget);var f=d.closest(b.rowClass);var h={module:"Products",view:"Discounts",record:f.find(".rowName .sourceField").val(),currency:b.getCurrency(),sourceModule:app.getModuleName(),sourceRecord:app.getRecordId(),totalPrice:b.getTotalPrice(f),accountField:a.find("#accountReferenceField").val(),};var c=jQuery.progressIndicator();AppConnector.request(h).then(function(e){app.showModalWindow(e,function(i){b.initDiscountsParameters(f,$(i));b.registerChangeDiscountModal(i,f,h)});c.hide()},function(e,i){c.hide()})})},registerChangeDiscountModal:function(a,c,d){var b=this;a.on("change",".individualDiscountType",function(g){var f=$(g.currentTarget);a.find(".individualDiscountContainer .input-group-addon").text(f.data("symbol"))});a.on("change",'.activeCheckbox[name="aggregationType"]',function(g){var f=$(g.currentTarget);if(f.attr("type")=="checkbox"&&this.checked){f.closest(".panel").find(".panel-body").show();f.closest(".panel").addClass("activepanel")}else{if(f.attr("type")=="radio"){a.find(".panel").removeClass("activepanel");a.find(".panel .panel-body").hide();f.closest(".panel").find(".panel-body").show();f.closest(".panel").addClass("activepanel")}else{f.closest(".panel").find(".panel-body").hide();f.closest(".panel").removeClass("activepanel")}}});a.on("change",".activeCheckbox, .globalDiscount,.individualDiscountValue,.individualDiscountType,.groupCheckbox",function(g){var f=$(g.currentTarget);b.calculateDiscount(c,a)});a.on("click",".saveDiscount",function(f){c.find(".discount").val(a.find(".valueDiscount").text());b.quantityChangeActions(c);b.saveDiscountsParameters(c,a);app.hideModalWindow()})},registerChangeTax:function(a){var b=this;a.on("click",".changeTax",function(g){var d=$(g.currentTarget);var f=d.closest(b.rowClass);var h={module:"Products",view:"Taxs",record:f.find(".rowName .sourceField").val(),recordModule:f.find('.rowName [name="popupReferenceModule"]').val(),currency:b.getCurrency(),sourceModule:app.getModuleName(),sourceRecord:app.getRecordId(),totalPrice:b.getTotalPrice(f),accountField:a.find("#accountReferenceField").val(),};var c=jQuery.progressIndicator();AppConnector.request(h).then(function(e){app.showModalWindow(e,function(i){b.initTaxParameters(f,$(i));b.registerChangeTaxModal(i,f,h)});c.hide()},function(e,i){c.hide()})})},registerChangeTaxModal:function(a,c,d){var b=this;a.on("change",".individualTaxType",function(g){var f=$(g.currentTarget);a.find(".individualTaxContainer .input-group-addon").text(f.data("symbol"))});a.on("change",'.activeCheckbox[name="aggregationType"]',function(g){var f=$(g.currentTarget);if(f.attr("type")=="checkbox"&&this.checked){f.closest(".panel").find(".panel-body").show();f.closest(".panel").addClass("activepanel")}else{if(f.attr("type")=="radio"){a.find(".panel").removeClass("activepanel");a.find(".panel .panel-body").hide();f.closest(".panel").find(".panel-body").show();f.closest(".panel").addClass("activepanel")}else{f.closest(".panel").find(".panel-body").hide();f.closest(".panel").removeClass("activepanel")}}});a.on("change",".activeCheckbox, .globalTax, .individualTaxValue, .groupTax, .regionalTax",function(g){var f=$(g.currentTarget);b.calculateTax(c,a)});a.on("click",".saveTaxs",function(f){c.find(".tax").val(a.find(".valueTax").text());b.quantityChangeActions(c);b.saveTaxsParameters(c,a);app.hideModalWindow()})},registerRowAutoComplete:function(a){var b=this;var c=a.find(".rowName .sourceField");c.on(Vtiger_Edit_Js.postReferenceSelectionEvent,function(k,h){var g=$(k.currentTarget);var j=g.closest(b.rowClass);if(h.data.label){var d=h.data.id}else{for(var l in h.data){var d=l}}var f=j.find('.rowName [name="popupReferenceModule"]').val();var i="index.php?module="+app.getModuleName()+"&action=GetDetails&record="+d+"&currency_id="+b.getCurrency();AppConnector.request(i).then(function(m){for(var n in m){if(typeof m[n]=="object"){var e=m[n];b.mapResultsToFields(f,j,e)}}},function(e,m){})})},initRow:function(a){var b=this;if(typeof a=="undefined"){a=b.getSupTableContainer()}b.registerDeleteLineItemEvent(a);b.registerPriceBookPopUp(a);b.registerRowChangeEvent(a);b.registerRowAutoComplete(a);b.checkDeleteIcon()},registerBasicEvents:function(a){this._super(a);this.registerSuppliesSaveData(a);this.registerAddRow(a);this.initRow();this.registerSortableRow();this.registerSubProducts(a);this.registerChangeDiscount(a);this.registerChangeTax(a);this.registerClearReferenceSelection(a);this.registerShowHideExpanded(a)},});